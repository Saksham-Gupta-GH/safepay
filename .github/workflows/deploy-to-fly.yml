name: Deploy to Fly

on:
  push:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install flyctl
        uses: superfly/flyctl-actions@v1
        with:
          version: latest

      - name: Authenticate with Fly
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
        run: |
          flyctl auth token "$FLY_API_TOKEN"

      - name: Set Fly secrets (MONGODB_URI, SECRET_KEY)
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
          MONGODB_URI: ${{ secrets.MONGODB_URI }}
          SECRET_KEY: ${{ secrets.SECRET_KEY }}
        run: |
          # Set secrets on Fly app; will fail if app doesn't exist â€” run `fly launch` locally once to create app or use flyctl CLI to create
          echo "Setting secrets on Fly (may fail if app not created yet)"
          flyctl secrets set MONGODB_URI="$MONGODB_URI" SECRET_KEY="$SECRET_KEY" || true

      - name: Deploy to Fly (remote build)
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
        run: |
          # Remote build is used so Fly builds the image; requires the app already exists (run `fly launch --name <app>` once locally)
          flyctl deploy --config fly.toml --remote-only || flyctl deploy --config fly.toml
